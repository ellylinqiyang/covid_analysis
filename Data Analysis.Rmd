---
title: 'Covid Analysis'
output: html_document
---

* Instructor: `Shree Bharadwaj`
* Team: MSCA Data Scientists 
  * `Jaird Meyer`
  * `Elly Yang`
  * `Mengyang Yu`
  * `XiaoJing Zhang`

Below is the results of a Multi-Criteria Decision Analysis using weighted linear combinations to rank each states on their response to Covid-19. The variables were grouped into 3 main categories: case and death metrics, hospital occupancy, and insurance coverage. The method is similar to principle component regression, but has the added flexibility of analyzing contingency and frequency tables as well as numeric data. The ranking was calculated from the loading coordinates generated by the Multiple Factor Analysis and appropriately weighted by the proportional variance each eigenvalue contained.

This test is based on aggregate data on cases and death totals per state as well as updates on insurance coverage and hospital occupancy levels. Therefore, this model does not require real time updates and can even generate tables and visualizations from various snapshots of data to compare how states have fared over time.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(MASS)
library(knitr)
library(readxl)
library(MASS)
library(formattable)
library(grid)
library(broom)
library(tidyr)
library(dplyr)
library(scales)
library(ggplot2)
library(ggthemes)
library(gridExtra)
library(data.table)
library(factoextra)
library(ggfortify)
library(kableExtra)
library(factoextra)
library(RColorBrewer)
library(FactoMineR)
library(factoextra)
```

```{r}
# Convert variables to percentages and per capitas
state <- read.csv('data/aggregated by state.csv')
state[,c(3:8,17,21:26,29)]<-state[,c(3:8,17,21:26,29)]*-1 # negative value inverts (ex. more deaths lowers score)
state_mfa = cbind(as.data.frame(scale((state[,3:4])/state[,15])),
                  state[9:13],
                  as.data.frame(scale(state[,c(19,20,24:26)]/state[,15])), 
                  as.data.frame(scale(state[,21:23]/100)),
                  as.data.frame(scale(state[,28:31]/state[,27])),
                  as.data.frame((state[,32:37]/state[,27])))
rownames(state_mfa) <- state[,1]
```

```{r}
# Multi Criteria Decision Analysis using Multiple Factor Regression
state.mfa <- MFA(state_mfa,
                 group=c(2,5,5,3,4,6),
                 type=c("s","f","s","s","s","f"), # s for scaling numeric, f for frequency
                 name.group=c("metrics","mask_use","hosp_beds","hosp_pct","coverage","pct_coverage"),
                 graph=TRUE)
```

```{r}
# solve linear combinations for each component
state.mfa.eig <- state.mfa$global.pca$eig[5,1] # eigenvalues for first five components
state.mfa.comp <- state.mfa$global.pca$var$coord[,1:5] # first five components
state.mfa.loading <- sweep(state.mfa.comp,2,sqrt(state.mfa.eig),FUN="/")
state.mfa.var <- state.mfa$global.pca$eig[1:5,2]/100 # variance of each component
state.mfa.lc.unweighted <- cbind(
    as.data.frame(rowSums(as.data.frame(t(t(state_mfa) * state.mfa.loading[,1])), na.rm=TRUE)),
    as.data.frame(rowSums(as.data.frame(t(t(state_mfa) * state.mfa.loading[,2])), na.rm=TRUE)),
    as.data.frame(rowSums(as.data.frame(t(t(state_mfa) * state.mfa.loading[,3])), na.rm=TRUE)),
    as.data.frame(rowSums(as.data.frame(t(t(state_mfa) * state.mfa.loading[,4])), na.rm=TRUE)),
    as.data.frame(rowSums(as.data.frame(t(t(state_mfa) * state.mfa.loading[,5])), na.rm=TRUE))
)
state.mfa.lc.weighted <- as.data.frame(t(t(state.mfa.lc.unweighted) * state.mfa.var))
```

```{r}
# final ranking
state.mfa.score <- as.data.frame(rowSums(state.mfa.lc.weighted))
state.mfa.rank <- as.data.frame(cbind(state[,1], state.mfa.score))
state.mfa.rank <- state.mfa.rank[order(-state.mfa.score),]
colnames(state.mfa.rank) <- c('State', 'Score')
rownames(state.mfa.rank) <- NULL
state.mfa.rank['Rank'] <- c(1:49)
formattable(state.mfa.rank, list(area(col = 2) ~ color_tile("pink", "lightgreen")), align="c")
```

```{r}
# scree plot
fviz_screeplot(state.mfa) 

# factor map
plot(state.mfa, choix="freq", invisible="ind", habillage="group") 

# quantitative variable map
fviz_mfa_var(state.mfa, "quanti.var", palette = "jco", 
             col.var.sup = "violet", repel = TRUE,
             geom = c("point", "text"), legend = "bottom") 

# individual state analysis
fviz_mfa_ind(state.mfa, col.ind = "cos2", gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"), repel = TRUE)

# group contributions
fviz_contrib(state.mfa, "group", axes = 1) # dim 1
fviz_contrib(state.mfa, "group", axes = 2) # dim 2
fviz_contrib(state.mfa, "group", axes = 3) # dim 3

# contributions to dimension 1 of quantitative variables
fviz_contrib(state.mfa, choice = "quanti.var", axes = 1, top = 20, palette = "jco")
fviz_contrib(state.mfa, choice = "quanti.var", axes = 2, top = 20, palette = "jco")
```
---
title: "Covid Analysis I"
output:
  html_document: default
  pdf_document: default
date: "Dec 2020"
---

* Instructor: Shree Bharadwaj
* Author(s): Jaird Meyer, Linqi Yang, Mengyang Yu, XiaoJing Zhang

## Description
The multi criteria decision analysis uses weighted linear combinations of variables to rank each state of its response to covid. The variables are grouped into three categories: insurance coverage, hospital utilization, and reported case. The method is similar to principle component analysis with the added flexibility of analyzing contingency tables and numeric data. The ranking is calculated from the loading coordinates generated by the multiple factor analysis and weighted by the proportional variance each eigenvalue contains. The analysis does not require real time updates and can generate insights from various snapshots of data to compare how states have fared over time.

## Data Analysis
```{r setup, message=FALSE}
library(MASS)
library(knitr)
library(readxl)
library(MASS)
library(formattable)
library(grid)
library(broom)
library(tidyr)
library(dplyr)
library(scales)
library(ggplot2)
library(ggthemes)
library(gridExtra)
library(data.table)
library(factoextra)
library(ggfortify)
library(kableExtra)
library(factoextra)
library(RColorBrewer)
library(FactoMineR)
library(factoextra)
```

```{r}
state <- read.csv('data/state.csv')

# invert values (ex. more deaths lower score)
state[,c(3:8,17,21:26,29)] <- state[,c(3:8,17,21:26,29)]*-1 

# convert variables to percentage and per capita
state_mfa <-cbind(as.data.frame(scale(state[,3:4]/state[,15])),
                  state[9:13],
                  as.data.frame(scale(state[,c(19,20,24:26)]/state[,15])), 
                  as.data.frame(scale(state[,21:23]/100)),
                  as.data.frame(scale(state[,28:31]/state[,27])),
                  as.data.frame((state[,32:37]/state[,27])))

# add state names: s for numeric scaling, f for frequency scaling
rownames(state_mfa) <- state[,1]

# multiple factor analysis
state.mfa <- MFA(state_mfa,
                 group=c(2,5,5,3,4,6),
                 type=c("s","f","s","s","s","f"), 
                 name.group=c("metrics","mask_use","hosp_beds","hosp_pct","coverage","pct_coverage"),
                 graph=FALSE)

# solve linear combinations for each component
state.mfa.comp <- state.mfa$global.pca$var$coord[,1:5] # first five components
state.mfa.eig <- state.mfa$global.pca$eig[5,1] # eigenvalue
state.mfa.loading <- sweep(state.mfa.comp,2,sqrt(state.mfa.eig),FUN="/") # loading
state.mfa.var <- state.mfa$global.pca$eig[1:5,2]/100 # variance
state.mfa.lc.unweighted <- cbind(
    as.data.frame(rowSums(as.data.frame(t(t(state_mfa) * state.mfa.loading[,1])), na.rm=TRUE)),
    as.data.frame(rowSums(as.data.frame(t(t(state_mfa) * state.mfa.loading[,2])), na.rm=TRUE)),
    as.data.frame(rowSums(as.data.frame(t(t(state_mfa) * state.mfa.loading[,3])), na.rm=TRUE)),
    as.data.frame(rowSums(as.data.frame(t(t(state_mfa) * state.mfa.loading[,4])), na.rm=TRUE)),
    as.data.frame(rowSums(as.data.frame(t(t(state_mfa) * state.mfa.loading[,5])), na.rm=TRUE))
)
state.mfa.lc.weighted <- as.data.frame(t(t(state.mfa.lc.unweighted) * state.mfa.var))

# final ranking
state.mfa.score <- as.data.frame(rowSums(state.mfa.lc.weighted))
state.mfa.rank <- as.data.frame(cbind(state[,1], state.mfa.score))
state.mfa.rank <- state.mfa.rank[order(-state.mfa.score),]
colnames(state.mfa.rank) <- c('State', 'Score')
rownames(state.mfa.rank) <- NULL
state.mfa.rank['Rank'] <- c(1:49)
formattable(state.mfa.rank, list(area(col=2) ~ color_tile("pink", "lightgreen")), align="c")
```

## Data Visualization
* [by county](https://public.tableau.com/app/profile/linqi.elly.yang/viz/CovidAnalysisbyCounty/County)
* [by state](https://public.tableau.com/app/profile/linqi.elly.yang/viz/CovidAnalysisbyState/State)
```{r}
fviz_screeplot(state.mfa) 

plot(state.mfa, choix="freq", invisible="ind", habillage="group") 

fviz_mfa_var(state.mfa, "quanti.var", palette="jco", col.var.sup="violet", 
             repel=TRUE, geom=c("point", "text"), legend="bottom") 

fviz_mfa_ind(state.mfa, col.ind="cos2", gradient.cols=c("#00AFBB", "#E7B800", "#FC4E07"), repel=TRUE)

fviz_contrib(state.mfa, "group", axes=1) 
fviz_contrib(state.mfa, "group", axes=2) 

fviz_contrib(state.mfa, choice="quanti.var", axes=1, top=20, palette="jco")
fviz_contrib(state.mfa, choice="quanti.var", axes=2, top=20, palette="jco")
```


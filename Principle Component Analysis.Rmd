---
title: 'Covid Mask Use Analysis'
output: html_document
---

```{r setup, include=FALSE}
library(MASS)
library(knitr)
library(readxl)
library(MASS)
library(formattable)
library(grid)
library(broom)
library(tidyr)
library(dplyr)
library(scales)
library(ggplot2)
library(ggthemes)
library(gridExtra)
library(data.table)
library(factoextra)
library(ggfortify)
library(kableExtra)
library(factoextra)
library(RColorBrewer)
library(FactoMineR)
library(factoextra)
```

* Instructor: `Shree Bharadwaj`
* Team: MSCA Data Scientists 
  * `Jaird Meyer`
  * `Elly Yang`
  * `Mengyang Yu`
  * `XiaoJing Zhang`

Below is the results of a Multi-Criteria Decision Analysis using weighted linear combinations to rank each states on their response to Covid-19. The variables were grouped into 3 main categories: case and death metrics, hospital occupancy, and insurance coverage. The method is similar to principle component regression, but has the added flexibility of analyzing contingency and frequency tables as well as numeric data. The ranking was calculated from the loading coordinates generated by the Multiple Factor Analysis and appropriately weighted by the proportional variance each eigenvalue contained.

This test is based on aggregate data on cases and death totals per state as well as updates on insurance coverage and hospital occupancy levels. Therefore, this model does not require real time updates and can even generate tables and visualizations from various snapshots of data to compare how states have fared over time.

## Convert variables to percentages and per capitas
```{r}
state <- read.csv('data/aggregated by state.csv')
state[,c(3:8,17,21:26,29)] <- state[,c(3:8,17,21:26,29)]*-1 # negative value for interpretation (ex. more cases lowers score)
metric_percap <- as.data.frame(scale((state[,3:7])/state[,15]))
hosp_percap <- as.data.frame(scale(state[,c(19,20,24:26)]/state[,15]))
hosp_pct <- as.data.frame(scale(state[,21:23]/100))
insurance <- as.data.frame(scale(state[,28:31]/state[,27]))
insurance_pct <- as.data.frame((state[,32:37]/state[,27]))
```

## Multi Criteria Decision Analysis (MCDA) using multiple factor regression
```{r}
state_numeric = as.data.frame(state[c(3:8,15:17,19:38)])
state_scale = cbind(state[1:2],
                    state_numeric[1:6],
                    state[9:14],
                    state_numeric[7:9],
                    state[18],
                    state_numeric[10:29],
                    hosp_percap,
                    insurance,
                    insurance_pct)
state_mfa = cbind(metric_percap[1:2],
                  state_scale[9:13],
                  hosp_percap,
                  hosp_pct,
                  insurance,
                  insurance_pct)
rownames(state_mfa) <- state[,1]
colnames(state_mfa) 
```

```{r}
## Grouping columns by variable type
state.mfa <- MFA(state_mfa,
                 group=c(2,5,5,3,4,6),
                 type=c("s","f","s","s","s","f"), # state_mfa_group_type -- s for scaling numeric and f for frequency (from contingency table) (n is for categorical indicators)
                 name.group=c("metrics","mask_use","hosp_beds","hosp_pct","coverage","pct_coverage"), #state_mfa_group_name
                 graph=FALSE)
```

```{r}
# data cleanup (presented as either a percentage or per capita)
state_pct_or_percap<-data.frame(state[1:2],(state[,3:7]/state[,15]),state[,21:23]/100,state[,c(19,20,24:26)]/state[,15],state[,28:31]/state[,27],state[,32:37]/state[,27])
write.csv(state_pct_or_percap,"~\\State_Data_Variables.csv", row.names = FALSE)
```

## Multi Factor Analysis
```{r}
#state.mfa
state.mfa.eig<-state.mfa$global.pca$eig[5,1] #eigen values for first five components
state.mfa.comp<-state.mfa$global.pca$var$coord[,1:5] #first five components
state.mfa.loading<-sweep(state.mfa.comp,2,sqrt(state.mfa.eig),FUN="/") #score aka loadings aka standard coords
#state.mfa$global.pca$var$cor
```

```{r}
#solve linear combinations for each component
state.mfa.l1<-as.data.frame(t(t(state_mfa) *state.mfa.loading[,1]))
state.mfa.l2<-as.data.frame(t(t(state_mfa) *state.mfa.loading[,2]))
state.mfa.l3<-as.data.frame(t(t(state_mfa) *state.mfa.loading[,3]))
state.mfa.l4<-as.data.frame(t(t(state_mfa) *state.mfa.loading[,4]))
state.mfa.l5<-as.data.frame(t(t(state_mfa) *state.mfa.loading[,5]))
state.mfa.l1.sum<-as.data.frame(rowSums(state.mfa.l1,na.rm=TRUE))
state.mfa.l2.sum<-as.data.frame(rowSums(state.mfa.l2,na.rm=TRUE))
state.mfa.l3.sum<-as.data.frame(rowSums(state.mfa.l3,na.rm=TRUE))
state.mfa.l4.sum<-as.data.frame(rowSums(state.mfa.l4,na.rm=TRUE))
state.mfa.l5.sum<-as.data.frame(rowSums(state.mfa.l5,na.rm=TRUE))
```

```{r}
#Weights
state.mfa.var<-state.mfa$global.pca$eig[1:5,2]/100 #variance of each component
state.mfa.lc.unweighted<-cbind(state.mfa.l1.sum,state.mfa.l2.sum,state.mfa.l3.sum,state.mfa.l4.sum,state.mfa.l5.sum)
#state.mfa.lc.unweighted
#state.mfa.var
state.mfa.lc.weighted<-as.data.frame(t(t(state.mfa.lc.unweighted)*state.mfa.var))
state.mfa$global.pca$eig[1:7,]
```

```{r}
#final ranking
state.mfa.score<-as.data.frame(rowSums(state.mfa.lc.weighted))
colnames(state.mfa.score)[1]<-'Score'
state.mfa.rank<-as.data.frame(cbind(state_scale[,1:2],state.mfa.score))
state.mfa.rank<-state.mfa.rank[order(-state.mfa.score),]
rownames(state.mfa.rank) <- 1:49
formattable(state.mfa.rank,list(area(col = 3) ~ color_tile("pink", "lightgreen")),align="c")
```

```{r}
#scree plot
fviz_screeplot(state.mfa)

#factor map
plot(state.mfa, choix="freq", invisible="ind", habillage="group")

#Quantitative variable map
fviz_mfa_var(state.mfa, "quanti.var", palette = "jco", 
             col.var.sup = "violet", repel = TRUE,
             geom = c("point", "text"), legend = "bottom")

#individual state analysis
fviz_mfa_ind(state.mfa, col.ind = "cos2", 
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE)

#Group contributions
fviz_contrib(state.mfa, "group", axes = 1) #dim 1
fviz_contrib(state.mfa, "group", axes = 2) #dim 2
fviz_contrib(state.mfa, "group", axes = 3) #dim 3

# Contributions to dimension 1 of quantitative variables
fviz_contrib(state.mfa, choice = "quanti.var", axes = 1, top = 20,
             palette = "jco")
fviz_contrib(state.mfa, choice = "quanti.var", axes = 2, top = 20,
             palette = "jco")

#MFA graph output
MFA(state_mfa,group=c(2,5,5,3,4,6),type=c("s","f","s","s","s","f"),name.group=c("metrics","mask_use","hosp_beds","hosp_pct","coverage","pct_coverage"),graph=TRUE)
```